<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        header {
            background-color: #4CAF50;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .filter-bar {
            display: flex;
            margin-bottom: 1rem;
        }
        .filter-bar input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .file-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .directory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #ddd;
            background: #eeffee;
        }
        .directory-item:last-child {
            border-bottom: none;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #ddd;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-actions button {
            margin-left: 0.5rem;
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .file-actions button.download {
            background-color: #4CAF50;
            color: white;
        }
        .file-actions button.rename {
            background-color: #2196F3;
            color: white;
        }
        .file-actions button.delete {
            background-color: #f44336;
            color: white;
        }
        .upload-area {
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
        }
        .upload-area button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
        }
        .modal {
            position: fixed;
            z-index: 1000;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            padding: 1rem;
        }
        .modal-content {
            position: relative;
            text-align: center;
        }
        .close {
            position: absolute;
            top: 8px;
            right: 12px;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }

    </style>
</head>
<body onload="DisplayFiles('/', '')">
    <header>
        <h1>File Manager</h1>
    </header>

    <div class="container">
        <div class="filter-bar">
            <input type="text" id="filter" placeholder="Filter files...">
        </div>
        <ul class="file-list" id="fileList"></ul>
        <div class="upload-area">
            <button id="uploadButton">Upload File</button>
            <button id="createDirButton">Create Directory</button>
            <button id="backButton">Back</button>
        </div>
    </div>

    <div id="renameModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Rename File</h2>
            <input type="text" id="newFileName" placeholder="Enter new file name">
            <button id="confirmRename">Rename</button>
            <button id="closeModal">Cancel</button>
        </div>
    </div>

    <div id="createDirModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Create New Directory</h2>
            <input type="text" id="newDirName" placeholder="Enter directory name">
            <button id="createDirectoryButton" onclick="CreateDirectory(createDirectoryButtonElement.value)">Create</button>
            <button id="closeDirModal">Cancel</button>
        </div>
    </div>

    <div id="uploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Upload File</h2>
            <form id="uploadForm" enctype="multipart/form-data" method="post">
                <label>Select files for upload:</label>
                <input style="display:inline;" type="file" id="files" name="files" multiple>
                <input type="submit" value="Upload">
                <button id="closeUploadModal">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        let currentDirectory = "/"
        const createDirectoryButtonElement = document.getElementById('newDirName')

        const filterElement = document.getElementById('filter');
        filterElement.addEventListener('input', () => {
            DisplayFiles(currentDirectory, filterElement.value)
        });



        document.getElementById('closeModal').addEventListener('click', function () {
            CloseRenameModal()
        });

        document.getElementById('backButton').addEventListener('click', async function () {
            await AccessParentDirectory()
        });

        document.getElementById('uploadButton').addEventListener('click', function (){
            ShowUploadModal()
        })

        document.getElementById('createDirButton').addEventListener('click', function () {
            ShowCreateDirModal()
        });

        document.getElementById('closeDirModal').addEventListener('click', function () {
            CloseCreateDirModal()
        });

        function CloseRenameModal() {document.getElementById('renameModal').style.display = 'none';}
        function ShowRenameModal(oldFilepath) {
            document.getElementById('renameModal').style.display = 'block';
            document.getElementById('newFileName').value = oldFilepath;
            document.getElementById('confirmRename').onclick = async function() {
                const newFileName = document.getElementById('newFileName').value;
                await RenameFile(oldFilepath, newFileName);
                CloseRenameModal()
            };
        }

        function CloseCreateDirModal() {document.getElementById('createDirModal').style.display = 'none';}
        function ShowCreateDirModal() {document.getElementById('createDirModal').style.display = 'block';}

        function ShowUploadModal() {document.getElementById('uploadModal').style.display = 'block';}
        function CloseUploadModal() {document.getElementById('uploadModal').style.display = 'none';}

        async function DisplayFiles(directoryPath, filter) {
            let files = await fetch(`/directory?path=${directoryPath}&filter=${filter}`)
            let filesJson = await files.json();
            let filesHtml = filesJson.map(JsonFileToTableRow)
            let fullHtml = filesHtml.join("\n")
            document.getElementById("fileList").innerHTML = fullHtml
        }

        function JsonFileToTableRow(file) {
            let html = ''
            let fileUrl = currentDirectory + file.Name
            if(file.IsDirectory){
                html = `<li class="directory-item" onclick="AccessDirectory('${file.Name}')">`
            }else{
                html = `<li class="file-item">`
            }
            return html +
                `<span>${file.Name}</span>
                <div class="file-actions">
                    <button class="download"><a href="/download?path=${fileUrl}">Download</a></button>
                    <button class="rename" onclick="ShowRenameModal('${fileUrl}')">Rename</button>
                    <button class="delete" onclick="DeleteFile('${fileUrl}')">Delete</button>
                </div>
            </li>`
        }

        async function AccessDirectory(directoryName) {
            currentDirectory = currentDirectory + directoryName + "/"
            filterElement.value = ''
            await DisplayFiles(currentDirectory, '')
        }

        async function AccessParentDirectory(){
            currentDirectory = GetParentDirectory(currentDirectory)
            if (currentDirectory === ""){
                currentDirectory = '/'
            }
            filterElement.value = ''
            await DisplayFiles(currentDirectory, '')
        }

        async function DeleteFile(filePath) {
            let result = await fetch(`/delete?path=${filePath}`)
            if(result.status === 200){
                await DisplayFiles(currentDirectory, filterElement.value)
            }
        }

        async function RenameFile(oldFilename, newFilename) {
            let result = await fetch(`/rename?old=${oldFilename}&new=${newFilename}`)
            if(result.status === 200){
                await DisplayFiles(currentDirectory, filterElement.value)
            }
        }

        async function CreateDirectory(name){
            let result = await fetch(`/create-directory?path=${name}`)
            if(result.status === 200){
                await DisplayFiles(currentDirectory, filterElement.value)
            }
            console.log(result.status)
            document.getElementById('createDirModal').style.display = 'none';
        }

        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);

            fetch(`/upload?path=${currentDirectory}`, { method: 'POST', body: formData })
                .then(response => {
                    if (response.ok) {
                        console.log('Files uploaded successfully!')
                        form.reset();
                        DisplayFiles(currentDirectory, filterElement.value)
                    }
                })
                .catch(error => {
                    console.error('Error uploading files:', error);
                });

            CloseUploadModal()
        });

        function GetParentDirectory(path) {
            const parts = path.split('/')
            const partsWithoutParent = parts.slice(0, parts.length-2)
            const joinedParts = partsWithoutParent.join("/")
            return joinedParts === "" ? '/' : joinedParts
        }

        document.getElementById('closeUploadModal').addEventListener('click', function (){
            CloseUploadModal()
        })
    </script>
</body>
</html>